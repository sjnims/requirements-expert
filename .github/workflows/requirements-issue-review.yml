name: Requirements Issue Review

# Claude-powered issue review specialized for requirements-expert plugin
# Evaluates issues against requirements engineering methodology and plugin workflow
#
# Differentiates from semantic-labeler.yml:
# - semantic-labeler: Applies labels based on content analysis
# - This workflow: Provides substantive quality feedback and clarifying questions
#
# Differentiates from claude.yml:
# - claude.yml: Responds to explicit @claude mentions
# - This workflow: Proactively reviews all new issues

on:
  issues:
    types: [opened]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  review-issue:
    name: Review Issue
    if: |
      github.actor != 'dependabot[bot]' &&
      github.actor != 'claude[bot]' &&
      !contains(github.event.issue.title, '@claude') &&
      !contains(github.event.issue.body, '@claude')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Review issue with Claude
        uses: anthropics/claude-code-action@f64219702d7454cf29fe32a74104be6ed43dc637 # v1.0.34
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Review this issue for the requirements-expert Claude Code plugin repository.

            ## Issue Context
            - Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
            - Author: ${{ github.event.issue.user.login }}
            - Labels: ${{ join(github.event.issue.labels.*.name, ', ') }}

            ## Issue Body
            ${{ github.event.issue.body }}

            ## Review Process

            ### 1. Gather context
            Read the plugin README and relevant documentation:
            ```bash
            # Understand plugin scope and workflow
            head -100 README.md

            # Check issue templates
            ls -la .github/ISSUE_TEMPLATE/ 2>/dev/null || echo "No templates"

            # Find potentially related open issues
            gh issue list --state open --limit 15 --json number,title
            ```

            ### 2. Classify the issue

            Determine which category applies:

            | Category | Indicators |
            |----------|------------|
            | **Lifecycle phase** | Mentions vision, epics, stories, tasks, prioritization, review |
            | **Plugin component** | References commands, skills, agents, hooks |
            | **GitHub integration** | About Projects, Issues, CLI, API |
            | **Workflow/CI** | About GitHub Actions, automation |
            | **Documentation** | README, CLAUDE.md, guides |
            | **General bug/enhancement** | Other functionality |

            ### 3. Evaluate against criteria

            **Baseline quality (all issues):**
            - Title clarity: Can you understand the issue from the title alone?
            - Context sufficiency: Is there enough background to understand the problem?
            - Actionability: Could a contributor start working on this?

            **For lifecycle/methodology issues, also evaluate:**
            - Does it align with the 8-phase workflow (init â†’ status)?
            - Does it consider GitHub Projects as the source of truth?
            - Does it follow requirements engineering best practices (INVEST, MoSCoW)?

            **For component issues (commands/skills/agents/hooks), also evaluate:**
            - Is the affected component clearly identified?
            - Is the current vs expected behavior described?
            - Does it consider the three-layer architecture?

            ### 4. Determine response

            **High quality issue:**
            Post a brief acknowledgment (2-3 sentences) noting:
            - Thanks for the clear issue
            - Any related issues found
            - Skip if nothing substantive to add

            **Needs clarification:**
            Post a focused comment with 1-3 specific questions. Examples:
            - "Which lifecycle phase does this affect?"
            - "What's the current behavior vs expected behavior?"
            - "Which command or skill is involved?"

            **Potential duplicate:**
            Link to the similar issue and ask for clarification.

            **Out of scope:**
            Politely explain and suggest alternatives if applicable.

            ### 5. Post comment

            Format:
            ```markdown
            {For high quality - brief acknowledgment}
            Thanks for the detailed issue! {Optional: note about related issues}

            {For needs clarification}
            A few quick questions to help us address this:

            1. {Specific question}
            2. {Specific question}

            {For potential duplicate}
            This looks similar to #XX. Is this the same issue or something different?

            ---
            ðŸ¤– Automated review
            ```

            **Guidelines:**
            - Keep comments under 150 words
            - Be welcoming, especially to new contributors
            - Don't repeat what labels already communicate
            - Skip commenting if the issue is already excellent

            Post with:
            ```bash
            gh issue comment ${{ github.event.issue.number }} --body "..."
            ```

          claude_args: |
            --allowedTools "Bash(gh issue:*),Read"
